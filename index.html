<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <title>GE ITLP Pyramid</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.0.8/semantic.css"/>
    <link rel="stylesheet" href="custom.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.0.8/semantic.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>
    <script src="utils.js"></script>
</head>
<body>

  <!-- TEMPLATES -->
  <script id="story-template" type="text/x-handlebars-template">
    {{#each stories}}
    <div class="item">
      <div class="content">
        <a class="header">{{title}}</a>
        <div class="meta">
          <a>{{itlp.name}}</a>
          Nominated by
          <a>{{author.name}}</a>
        </div>
        <div class="description">
          {{body}}
        </div>
        <div class="extra">
            <div class="ui right floated animated button congratsBtn" data-storyid="{{id}}">
              <div class="visible content">{{congrats}} <i class="right thumbs up icon"></i></div>
              <div class="hidden content">Congrats!</div>
            </div>
        </div>
      </div>
    </div>
    {{/each}}
  </script>

  <!-- MENU -->

  <div class="ui stackable container menu inverted">
    <a href="index.html" class="item">Stories</a>
    <a id="aWriteStory" href="writeStory.html?isAuthor=1" class="hide item right">Write Story</a>
    <a id="aApproveStory" href="approveStories.html?isApprover=1" class="hide item right">Approve Stories</a>
  </div>

  <!-- STORY LIST -->

  <h1 class="ui center aligned header">Stories</h1>
  <div class="ui container">
    <div id="storyList" class="ui relaxed divided items">
    </div>
  </div>

  <script type="text/javascript">
    // $('.ui.accordion').accordion();
    var source = $("#story-template").html();
    var template = Handlebars.compile(source);
    var data;

    // data = {"stories": [{"title": "Dummy Title", "author": {"sso": "212411766", "name": "Pei Pang"}, "body": "body", "congrats": 5, "itlp": {"sso": "212447791", "name": "Jun Raymond Ma"}, "approvals": 0}
    //                   , {"title": "Dummy Title 2", "author": {"sso": "212447791", "name": "Jun Raymond Ma"}, "body": "body2", "congrats": 19, "itlp": {"sso": "212411766", "name": "Pei Pang"}, "approvals": 1}
    //       ]};
    // $('#storyList').append(template(data));

    $.ajax({
      url: 'https://itlp.herokuapp.com/stories/'
    , type: 'GET'
    })
    .done(function(response) {
      response.stories = response.stories.filter(function(story) {
        return story.approvals >= 5;
      });
      $('#storyList').append(template(response));
      $('#storyList').removeClass('active loader');
    });

    var user = JSON.parse(localStorage.getItem('user'))
    if (user.isApprover) {
      $('#aApproveStory').removeClass('hide');
    }
    if (user.isAuthor) {
      $('#aWriteStory').removeClass('hide');
    }

    $('#storyList').on('click', '.congratsBtn', function() {
      var $self = $(this);
      var myData = {
          user: user.sso,
          story: $self.data('storyid')
        };
      console.log(myData);
      $.ajax({
        url: 'http://itlp.herokuapp.com/add/congrat/',
        type: 'get',
        data: myData
      })
      .done(function(response){
        console.log(response);
      });
    });
  </script>
</body>
</html>
